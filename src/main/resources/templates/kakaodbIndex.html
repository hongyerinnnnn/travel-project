<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>관광 명소 찾기 (Kakao Map + DB)</title>
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=b128209c9ae4dab493ade5f50b63bdcb&autoload=false&libraries=services,clusterer"></script>
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; font-family: Pretendard, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans KR", Arial; }
        header { padding: 14px 18px; border-bottom: 1px solid #eee; display:flex; gap:12px; align-items:center; }
        header h1 { font-size: 18px; margin: 0 8px 0 0; }
        header .hint { color:#666; font-size: 13px; }
        .container { display: grid; grid-template-columns: 380px 1fr; height: calc(100vh - 60px); }
        .left { border-right: 1px solid #eee; padding: 12px; overflow: auto; }
        .left h2 { margin: 6px 0 10px; font-size: 16px; }
        .results { margin-top: 12px; display: grid; gap:8px; }
        .card { border:1px solid #eee; border-radius:12px; padding:10px; cursor:pointer; }
        .card h3 { margin: 0; font-size: 15px; }
        .map { position: relative; }
        #map { width: 100%; height: 100%; min-height: 420px; }
    </style>
</head>
<body>
<header>
    <h1>관광 명소 찾기</h1>
    <span class="hint">Kakao Maps + DB 연동</span>
</header>
<div class="container">
    <aside class="left">
        <h2>DB 관광지 목록</h2>
        <div class="results" id="dbResults"></div>
    </aside>
    <main class="map">
        <div id="map"></div>
    </main>
</div>

<script>
    kakao.maps.load(function() {
        const mapContainer = document.getElementById('map');
        const mapOption = { center: new kakao.maps.LatLng(37.5665, 126.9780), level: 6 };
        const map = new kakao.maps.Map(mapContainer, mapOption);
        const infowindow = new kakao.maps.InfoWindow({ zIndex: 1 });
        const $dbResults = document.getElementById('dbResults');
        let dbMarkers = [];

        function clearMarkers() {
            dbMarkers.forEach(m => m.setMap(null));
            dbMarkers = [];
        }

        async function loadTravelData() {
            try {
                const res = await fetch("/api/travels"); // 전체 명소 목록
                const data = await res.json();
                renderTravelList(data);
            } catch (e) {
                console.error("DB 데이터 로드 실패", e);
            }
        }

        function renderTravelList(items) {
            $dbResults.innerHTML = "";
            clearMarkers();

            items.forEach((t, idx) => {
                const card = document.createElement("div");
                card.className = "card";
                card.innerHTML = `<h3>${idx+1}. ${t.title}</h3>`; // 제목만 표시
                $dbResults.appendChild(card);

                if (t.lat && t.lng) {
                    const pos = new kakao.maps.LatLng(t.lat, t.lng);
                    const marker = new kakao.maps.Marker({ position: pos });
                    marker.setMap(map);
                    dbMarkers.push(marker);

                    // 마커 클릭 시 인포윈도우
                    kakao.maps.event.addListener(marker, "click", function() {
                        const html = `
                        <div style="padding:6px 8px">
                            <strong>${t.title}</strong><br>
                            ${t.description || ""}<br>
                            📍 ${t.address}<br>
                            ☎ ${t.phone || "-"}
                        </div>`;
                        infowindow.setContent(html);
                        infowindow.open(map, marker);
                    });

                    // 카드 클릭 시 마커 중심으로 이동 + 정보 표시
                    card.onclick = () => {
                        map.panTo(pos);
                        const html = `
                        <div style="padding:6px 8px">
                            <strong>${t.title}</strong><br>
                            ${t.description || ""}<br>
                            📍 ${t.address}<br>
                            ☎ ${t.phone || "-"}
                        </div>`;
                        infowindow.setContent(html);
                        infowindow.open(map, marker);
                    };
                } else {
                    card.onclick = () => alert("이 관광지는 좌표 정보가 없습니다.");
                }
            });
        }

        loadTravelData();
    });
</script>
</body>
</html>